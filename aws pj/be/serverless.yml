service: docqa-aws-bedrock

provider:
  name: aws
  runtime: python3.9
  region: us-east-1
  stage: dev
  timeout: 900  # 15 minutes max for document processing
  memorySize: 3008  # Max for better performance
  
  environment:
    S3_BUCKET: docqa-uploads-${self:provider.stage}
    
  iamRoleStatements:
    - Effect: Allow
      Action:
        - bedrock:InvokeModel
        - bedrock:ListFoundationModels
      Resource: "*"
    - Effect: Allow
      Action:
        - s3:*
      Resource: 
        - arn:aws:s3:::docqa-uploads-${self:provider.stage}
        - arn:aws:s3:::docqa-uploads-${self:provider.stage}/*
    - Effect: Allow
      Action:
        - dynamodb:*
      Resource: 
        - arn:aws:dynamodb:${self:provider.region}:*:table/DocQASessions
    - Effect: Allow
      Action:
        - logs:*
      Resource: "*"

package:
  patterns:
    - "!node_modules/**"
    - "!venv/**"
    - "!__pycache__/**"
    - "!*.pyc"
    - "!package-lock.json"

functions:
  presign:
    handler: handler.presign
    events:
      - http:
          path: presign
          method: post
          cors: true

  upload:
    handler: handler.upload
    events:
      - http:
          path: upload
          method: post
          cors: true
    memorySize: 3008
    timeout: 300  # 5 minutes for upload

  ask:
    handler: handler.ask
    events:
      - http:
          path: ask
          method: post
          cors: true
    memorySize: 1024
    timeout: 30

resources:
  Resources:
    UploadsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: docqa-uploads-${self:provider.stage}
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET, PUT, POST, DELETE, HEAD]
              AllowedOrigins: ['*']
              MaxAge: 3000

    WebsiteBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: docqa-website-${self:provider.stage}
        WebsiteConfiguration:
          IndexDocument: index.html
          ErrorDocument: index.html
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false

    WebsiteBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref WebsiteBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action: 
                - s3:GetObject
                - s3:ListBucket
              Resource: 
                - !Join ['', ['arn:aws:s3:::', !Ref WebsiteBucket]]
                - !Join ['', ['arn:aws:s3:::', !Ref WebsiteBucket, '/*']]

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: DocQASessions
        AttributeDefinitions:
          - AttributeName: session_id
            AttributeType: S
        KeySchema:
          - AttributeName: session_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: expires_at
          Enabled: true

Outputs:
  WebsiteURL:
    Value: !GetAtt WebsiteBucket.WebsiteURL
    Description: URL của website frontend
  ApiURL:
    Value: !Sub https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${sls:stage}
    Description: URL của API Gateway